<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Pro Stock Trading Dashboard</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
:root {
    --bg: #0f172a;
    --card: rgba(255,255,255,0.06);
    --border: rgba(255,255,255,0.12);
    --text: #e5e7eb;
    --muted: #94a3b8;
    --green: #22c55e;
    --red: #ef4444;
    --blue: #38bdf8;
    --yellow: #facc15;
}

* { box-sizing: border-box; font-family: 'Inter', sans-serif; }

body {
    margin: 0;
    background: radial-gradient(circle at top, #020617, #0f172a);
    color: var(--text);
    min-height: 100vh;
}

.hidden { display: none !important; }

.container { max-width: 1400px; margin: auto; padding: 24px; }

/* ---------- Header ---------- */
.header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
.header h1 { font-size: 1.6rem; font-weight: 600; margin: 0; background: linear-gradient(to right, var(--blue), var(--green)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;}
#connection-status { padding: 8px 14px; border-radius: 999px; font-size: 0.85rem; font-weight: 500; background: var(--card); border: 1px solid var(--border); }

/* ---------- Auth (Page 1) ---------- */
.auth-card {
    max-width: 420px; margin: 80px auto; background: var(--card);
    border: 1px solid var(--border); border-radius: 16px; padding: 24px;
    backdrop-filter: blur(10px);
}
.auth-card h2 { margin-bottom: 16px; text-align: center; margin-top: 0;}
.auth-form input {
    width: 100%; padding: 12px; margin-bottom: 12px; background: transparent;
    border: 1px solid var(--border); border-radius: 10px; color: var(--text);
}
.auth-form button {
    width: 100%; padding: 12px; border-radius: 10px; border: none;
    background: var(--blue); font-weight: 600; cursor: pointer; color: #000;
}
.auth-form button:hover { opacity: 0.9; }
.auth-toggle { margin-top: 12px; text-align: center; font-size: 0.85rem; color: var(--muted); cursor: pointer; }

/* ---------- Dashboard (Page 2) ---------- */
.dashboard-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }

.card {
    background: var(--card); border: 1px solid var(--border);
    border-radius: 16px; padding: 20px; backdrop-filter: blur(10px);
}
.card h3 { margin-top: 0; margin-bottom: 16px; font-size: 1.1rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; }

/* Stock Cards */
.stock-grid { display: grid; grid-template-columns: repeat(auto-fit,minmax(240px,1fr)); gap: 16px; }
.stock-card {
    background: rgba(0,0,0,0.2); border-radius: 14px; padding: 16px;
    border: 1px solid var(--border); transition: transform 0.2s; cursor: pointer;
    position: relative;
}
.stock-card:hover { transform: translateY(-4px); border-color: var(--blue); box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
.stock-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;}
.price-text { font-size: 1.5rem; font-weight: 700; display: block; margin: 12px 0; }

.trading-controls { display: flex; gap: 6px; margin-top: 12px; }
.trading-controls input {
    width: 50px; padding: 8px; border-radius: 8px; border: 1px solid var(--border);
    background: transparent; color: var(--text); text-align: center;
}
.trade-btn { flex: 1; border-radius: 8px; border: none; cursor: pointer; font-size: 0.8rem; font-weight: 600; color: white; padding: 8px;}
.buy-btn { background: var(--green); }
.sell-btn { background: var(--red); }
.sub-btn { width: 100%; margin-top: 8px; padding: 8px; border-radius: 8px; border: none; background: var(--card); color: var(--muted); cursor: pointer; border: 1px solid var(--border); font-size: 0.8rem;}
.sub-btn.active { background: var(--yellow); color: #000; border-color: var(--yellow); }

/* Portfolio Sidebar */
.stat { display: flex; justify-content: space-between; font-size: 0.95rem; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid var(--border); }
.stat:last-child { border-bottom: none; }
.stat span:last-child { font-weight: 600; font-family: monospace; font-size: 1.1rem; }

/* Tables */
table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; }
th { text-align: left; color: var(--muted); font-weight: 500; padding: 12px 8px; border-bottom: 1px solid var(--border); }
td { padding: 12px 8px; border-bottom: 1px solid var(--border); }
tr:last-child td { border-bottom: none; }

/* ---------- Detail View (Page 3) ---------- */
.back-btn {
    background: var(--card); border: 1px solid var(--border); color: var(--text);
    padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;
    margin-bottom: 20px; display: inline-flex; align-items: center; gap: 8px;
}
.back-btn:hover { background: rgba(255,255,255,0.1); }

.detail-layout { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }
.chart-box { height: 400px; position: relative; width: 100%; }
.scrollable-table { max-height: 400px; overflow-y: auto; }

/* Alerts */
#alert-notification {
    position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
    background: var(--blue); color: #000; padding: 14px 24px;
    border-radius: 12px; display: none; z-index: 999; font-weight: 600;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}

/* Colors */
.up { color: var(--green); }
.down { color: var(--red); }
.blink-up { animation: blink-up 0.5s ease-out; }
.blink-down { animation: blink-down 0.5s ease-out; }
@keyframes blink-up { 0% { background-color: rgba(34, 197, 94, 0.2); } 100% { background-color: transparent; } }
@keyframes blink-down { 0% { background-color: rgba(239, 68, 68, 0.2); } 100% { background-color: transparent; } }

@media(max-width: 900px){
    .dashboard-grid, .detail-layout { grid-template-columns: 1fr; }
    .market-section { order: 2; }
    .portfolio-section { order: 1; }
}
</style>
</head>

<body onload="checkAuth()">

<div id="alert-notification"></div>

<div class="container">

    <div class="header">
        <h1>üìà Pro Stock Dashboard</h1>
        <div style="display:flex; gap:10px; align-items:center;">
             <div id="connection-status">Disconnected</div>
             <button id="logout-btn" class="hidden" onclick="logoutUser()" style="background:var(--red); border:none; color:white; padding:6px 12px; border-radius:6px; cursor:pointer;">Logout</button>
        </div>
    </div>

    <div id="auth-view" class="auth-card">
        <div id="login-form">
            <h2>Sign In</h2>
            <form class="auth-form" onsubmit="loginUser(event)">
                <input type="email" id="login-email" placeholder="Email" required />
                <input type="password" id="login-password" placeholder="Password" required />
                <button>Login</button>
            </form>
            <div class="auth-toggle" onclick="toggleAuthForm('register')">Create an account</div>
        </div>

        <div id="register-form" class="hidden">
            <h2>Create Account</h2>
            <form class="auth-form" onsubmit="registerUser(event)">
                <input type="email" id="register-email" placeholder="Email" required />
                <input type="password" id="register-password" placeholder="Password" required />
                <button>Create</button>
            </form>
            <div class="auth-toggle" onclick="toggleAuthForm('login')">Already registered?</div>
        </div>
    </div>

    <div id="dashboard-view" class="hidden">
        <div class="dashboard-grid">
            
            <div class="card market-section">
                <h3>Live Market (Click card for details)</h3>
                <div id="stock-list" class="stock-grid"></div>
            </div>

            <div class="card portfolio-section">
                <h3>My Portfolio <small id="current-user-email" style="font-size:0.7rem; color:var(--blue);"></small></h3>
                <div class="stat"><span>Available Cash</span><span id="cash-balance" class="up">$--</span></div>
                <div class="stat"><span>Holdings Value</span><span id="portfolio-value">$--</span></div>
                <div class="stat"><span>Total P&L</span><span id="total-pl-value">$--</span></div>
                <div class="stat"><span>Total Equity</span><span id="total-equity">$--</span></div>
                <div id="trade-message" style="margin-top:10px; font-size:0.85rem; font-weight:bold; min-height:1.2em;"></div>

                <h4 style="margin-top:20px; color:var(--muted); font-size:0.9rem;">Current Positions</h4>
                <table>
                    <thead><tr><th>Ticker</th><th>Qty</th><th>Avg</th><th>P&L</th></tr></thead>
                    <tbody id="portfolio-table-body"></tbody>
                </table>
                
                <div style="margin-top:20px; border-top:1px solid var(--border); padding-top:10px;">
                     <div style="display:flex; gap:5px;">
                        <select id="alert-ticker" style="background:var(--bg); border:1px solid var(--border); color:white; padding:5px; border-radius:6px;"></select>
                        <input type="number" id="alert-threshold" placeholder="Price" style="width:70px; background:var(--bg); border:1px solid var(--border); color:white; padding:5px; border-radius:6px;">
                        <button onclick="sendAlert()" style="background:var(--blue); border:none; border-radius:6px; cursor:pointer; font-weight:bold;">Set</button>
                     </div>
                     <ul id="active-alerts-list" style="padding-left:15px; font-size:0.8rem; color:var(--muted); margin-top:5px;"></ul>
                </div>
            </div>
        </div>
    </div>

    <div id="detail-view" class="hidden">
        <button class="back-btn" onclick="navigateToDashboard()">
            ‚Üê Back to Dashboard
        </button>

        <div class="detail-layout">
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h3><span id="detail-ticker-name">STOCK</span> Chart</h3>
                    <select id="chart-timeframe" onchange="initChart()" style="background:var(--bg); color:white; border:1px solid var(--border); padding:4px; border-radius:4px;">
                        <option value="60s">Live (60s)</option>
                        <option value="24h">Daily (24h)</option>
                        <option value="30d">Monthly (30d)</option>
                    </select>
                </div>
                <div class="chart-box">
                    <canvas id="livePriceChart"></canvas>
                </div>
            </div>

            <div class="card">
                <h3>Trade History</h3>
                <div class="scrollable-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Action</th>
                                <th>Sym</th>
                                <th>Price</th>
                                <th>Time</th>
                            </tr>
                        </thead>
                        <tbody id="transaction-log-body-detail">
                            <tr><td colspan="4" style="text-align:center; color:var(--muted)">Select a stock to view history</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
    const SUPPORTED_STOCKS = ['GOOG', 'TSLA', 'AMZN', 'META', 'NVDA'];
    const LOCAL_STORAGE_KEY_TOKEN = 'authToken';
    const BASE_URL = 'https://stock-exch-production.up.railway.app'; // Production URL

    const CHART_HISTORY_LENGTH_SECONDS = 60;
    
    let ws = null;
    let currentUserEmail = null;
    let subscribedTickers = new Set();
    let lastPrices = {}; 
    let currentPortfolio = {}; 
    let currentCash = 0;
    let activeAlerts = {}; 
    let riskMetrics = {};
    
    let priceHistory = {}; 
    let priceChart = null; 
    let currentTicker = 'GOOG'; 
    let fullTransactionLog = [];

    // --- DOM Elements ---
    const statusElement = document.getElementById('connection-status');
    const authView = document.getElementById('auth-view');
    const dashboardView = document.getElementById('dashboard-view');
    const detailView = document.getElementById('detail-view');
    const logoutBtn = document.getElementById('logout-btn');
    
    // --- Routing Logic ---
    function checkAuth() {
        const token = localStorage.getItem(LOCAL_STORAGE_KEY_TOKEN);
        if (token) {
            authView.classList.add('hidden');
            dashboardView.classList.remove('hidden');
            detailView.classList.add('hidden');
            logoutBtn.classList.remove('hidden');
            
            statusElement.textContent = 'Connecting...';
            statusElement.style.color = 'var(--yellow)';
            connectWebSocket(token);
        } else {
            authView.classList.remove('hidden');
            dashboardView.classList.add('hidden');
            detailView.classList.add('hidden');
            logoutBtn.classList.add('hidden');
        }
    }

    function navigateToDashboard() {
        dashboardView.classList.remove('hidden');
        detailView.classList.add('hidden');
    }

    // THIS IS THE KEY FIX FOR YOUR ISSUE:
    function navigateToDetail(ticker) {
        currentTicker = ticker; // FORCE Update current ticker
        document.getElementById('detail-ticker-name').textContent = ticker;
        
        dashboardView.classList.add('hidden');
        detailView.classList.remove('hidden');

        // Re-initialize chart and history for THIS specific stock
        initChart();
        renderTransactionLog();
    }

    function toggleAuthForm(formId) {
        document.getElementById('login-form').classList.toggle('hidden', formId !== 'login');
        document.getElementById('register-form').classList.toggle('hidden', formId !== 'register');
    }

    // --- API Calls (Auth) ---
    async function registerUser(event) {
        event.preventDefault();
        const email = document.getElementById('register-email').value;
        const password = document.getElementById('register-password').value;
        try {
            const res = await fetch(`${BASE_URL}/api/auth/register`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });
            const data = await res.json();
            if (res.ok) handleAuthSuccess(data.token, data.email);
            else alert(data.msg || 'Registration failed');
        } catch (err) { alert('Server error'); }
    }
    
    async function loginUser(event) {
        event.preventDefault();
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        try {
            const res = await fetch(`${BASE_URL}/api/auth/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });
            const data = await res.json();
            if (res.ok) handleAuthSuccess(data.token, data.email);
            else alert(data.msg || 'Login failed');
        } catch (err) { alert('Server error'); }
    }

    function handleAuthSuccess(token, email) {
        localStorage.setItem(LOCAL_STORAGE_KEY_TOKEN, token);
        currentUserEmail = email;
        checkAuth();
    }

    function logoutUser() {
        localStorage.removeItem(LOCAL_STORAGE_KEY_TOKEN);
        if (ws) ws.close();
        window.location.reload(); 
    }

    // --- WebSocket ---
    function connectWebSocket(token) {
        ws = new WebSocket(`${BASE_URL.replace('http', 'ws')}?token=${token}`);
        
        ws.onopen = () => {
            statusElement.textContent = 'Connected';
            statusElement.style.color = 'var(--green)';
            statusElement.style.borderColor = 'var(--green)';
        };

        ws.onmessage = (event) => {
            const message = JSON.parse(event.data);
            
            if (message.type === 'INIT') {
                currentUserEmail = message.email;
                document.getElementById('current-user-email').textContent = currentUserEmail;
                currentCash = parseFloat(message.cash);
                currentPortfolio = message.portfolio;
                lastPrices = message.stocks;
                subscribedTickers = new Set(message.subscriptions);
                activeAlerts = message.activeAlerts; 
                riskMetrics = message.riskMetrics; 
                fullTransactionLog = message.transactions || []; 
                
                simulateHistoricalData(message.stocks); 
                renderMarketGrid(message.stocks);
                updatePortfolioView();
                initAlertSelect(); 
                renderActiveAlerts(); 
                
            } else if (message.type === 'PRICE_UPDATE') {
                currentCash = parseFloat(message.cash);
                currentPortfolio = message.portfolio; 
                activeAlerts = message.activeAlerts; 
                
                updatePrices(message.data);
                updatePriceHistory(message.data); 
                updatePortfolioView(); 
                renderActiveAlerts();
                
            } else if (message.type === 'PORTFOLIO_UPDATE') {
                currentCash = parseFloat(message.cash);
                currentPortfolio = message.portfolio; 
                showTradeMessage(message.tradeMsg);
                handleTradeMessage(message.tradeMsg); 
                updatePortfolioView(); 
                
            } else if (message.type === 'ALERT_SET_SUCCESS') {
                activeAlerts = message.activeAlerts;
                showTradeMessage(message.tradeMsg);
                renderActiveAlerts();
            } else if (message.type === 'ALERT_TRIGGERED') {
                message.alerts.forEach(alert => {
                    showNotification(`üîî ${alert.ticker}: $${alert.price}`);
                });
                activeAlerts = message.activeAlerts; 
                renderActiveAlerts();
            } else if (message.type === 'ERROR') {
                alert(message.message);
                logoutUser();
            }
        };

        ws.onclose = () => {
            statusElement.textContent = 'Disconnected';
            statusElement.style.color = 'var(--red)';
        };
    }

    // --- UI Rendering ---
    function renderMarketGrid(stocks) {
        const grid = document.getElementById('stock-list');
        grid.innerHTML = '';
        SUPPORTED_STOCKS.forEach(ticker => {
            const price = stocks[ticker];
            const div = document.createElement('div');
            div.className = 'stock-card';
            div.id = `card-${ticker}`;
            // CLICKING THE CARD OPENS PAGE 3
            div.onclick = () => navigateToDetail(ticker);
            div.innerHTML = `
                <div class="stock-header">
                    <span style="font-weight:700; color:var(--muted)">${ticker}</span>
                    <span id="change-${ticker}" style="font-size:0.8rem">--</span>
                </div>
                <span id="price-${ticker}" class="price-text">$${price.toFixed(2)}</span>
                <div class="trading-controls">
                    <input type="number" id="qty-${ticker}" value="1" min="1" onclick="event.stopPropagation()">
                    <button class="trade-btn buy-btn" onclick="event.stopPropagation(); sendTrade('${ticker}', 'BUY')">BUY</button>
                    <button class="trade-btn sell-btn" onclick="event.stopPropagation(); sendTrade('${ticker}', 'SELL')">SELL</button>
                </div>
                <button class="sub-btn" id="btn-sub-${ticker}" onclick="event.stopPropagation(); toggleSubscription('${ticker}')">
                    Subscribe
                </button>
            `;
            grid.appendChild(div);
            updateButtonState(ticker);
        });
    }

    function updatePrices(data) {
        for (const [ticker, newPrice] of Object.entries(data)) {
            const priceEl = document.getElementById(`price-${ticker}`);
            const changeEl = document.getElementById(`change-${ticker}`);
            
            if (priceEl) { 
                const newVal = parseFloat(newPrice);
                const oldVal = lastPrices[ticker] || newVal;
                const change = newVal - oldVal;

                priceEl.textContent = `$${newVal.toFixed(2)}`;
                changeEl.innerHTML = change >= 0 
                    ? `<span class="up">+${change.toFixed(2)}</span>` 
                    : `<span class="down">${change.toFixed(2)}</span>`;

                if(subscribedTickers.has(ticker)) {
                    priceEl.classList.remove('blink-up', 'blink-down');
                    void priceEl.offsetWidth; 
                    priceEl.classList.add(change >= 0 ? 'blink-up' : 'blink-down');
                }
                
                lastPrices[ticker] = newVal;
            }
        }
    }

    function updatePortfolioView() {
        const tbody = document.getElementById('portfolio-table-body');
        tbody.innerHTML = '';
        let totalVal = 0, totalPL = 0;

        for (const ticker in currentPortfolio) {
            const h = currentPortfolio[ticker];
            if (h.quantity > 0) {
                const price = lastPrices[ticker] || h.avgPrice;
                const val = h.quantity * price;
                const cost = h.quantity * h.avgPrice;
                const pl = val - cost;
                
                totalVal += val;
                totalPL += pl;

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="font-weight:600">${ticker}</td>
                    <td>${h.quantity}</td>
                    <td>$${h.avgPrice.toFixed(1)}</td>
                    <td class="${pl>=0?'up':'down'}">${pl>=0?'+':''}${pl.toFixed(1)}</td>
                `;
                tbody.appendChild(tr);
            }
        }
        
        document.getElementById('cash-balance').textContent = `$${currentCash.toFixed(2)}`;
        document.getElementById('portfolio-value').textContent = `$${totalVal.toFixed(2)}`;
        const plEl = document.getElementById('total-pl-value');
        plEl.textContent = `${totalPL>=0?'+':''}$${totalPL.toFixed(2)}`;
        plEl.className = totalPL >= 0 ? 'up' : 'down';
        document.getElementById('total-equity').textContent = `$${(currentCash+totalVal).toFixed(2)}`;
    }

    function renderTransactionLog() {
        const tbody = document.getElementById('transaction-log-body-detail');
        tbody.innerHTML = '';
        const logs = fullTransactionLog.filter(l => l.ticker === currentTicker);

        if (logs.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:var(--muted); padding:20px;">No trades yet for this stock</td></tr>';
            return;
        }

        logs.forEach(log => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="${log.action === 'BUY' ? 'down' : 'up'}" style="font-weight:600">${log.action}</td>
                <td>${log.ticker}</td>
                <td>$${log.price.toFixed(2)}</td>
                <td style="color:var(--muted); font-size:0.8rem">${log.time}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    // --- Charting ---
    function simulateHistoricalData(initialStocks) {
        const now = new Date();
        priceHistory = {};
        
        SUPPORTED_STOCKS.forEach(ticker => {
            priceHistory[ticker] = { 
                '60s': { t: [], p: [] }, 
                '24h': { t: [], p: [] }, 
                '30d': { t: [], p: [] } 
            };

            let currentPrice = initialStocks[ticker];

            // --- 60s (Live) ---
            for(let i=0; i<60; i++) {
                 priceHistory[ticker]['60s'].t.push(new Date(now - (60-i)*1000).toLocaleTimeString());
                 priceHistory[ticker]['60s'].p.push(currentPrice + (Math.random()-0.5)*2);
            }

            // --- 24h (Hourly) ---
            for(let i=0; i<=24; i++) {
                const timeLabel = new Date(now - (24-i)*3600000).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                priceHistory[ticker]['24h'].t.push(timeLabel);
                priceHistory[ticker]['24h'].p.push(currentPrice + (Math.random()-0.5)*10); 
            }

            // --- 30d (Daily) ---
            for(let i=0; i<=30; i++) {
                const dateLabel = new Date(now - (30-i)*24*3600000).toLocaleDateString();
                priceHistory[ticker]['30d'].t.push(dateLabel);
                priceHistory[ticker]['30d'].p.push(currentPrice + (Math.random()-0.5)*20);
            }
        });
    }

    function updatePriceHistory(newPrices) {
        const now = new Date().toLocaleTimeString();
        SUPPORTED_STOCKS.forEach(t => {
            if(priceHistory[t] && newPrices[t]) {
                priceHistory[t]['60s'].p.push(newPrices[t]);
                priceHistory[t]['60s'].t.push(now);
                if(priceHistory[t]['60s'].p.length > 60) {
                    priceHistory[t]['60s'].p.shift();
                    priceHistory[t]['60s'].t.shift();
                }
            }
        });
        // Only update if Detail view is visible
        if(!document.getElementById('detail-view').classList.contains('hidden')) {
             if(document.getElementById('chart-timeframe').value === '60s') updateChart();
        }
    }

    function initChart() {
        const ctx = document.getElementById('livePriceChart').getContext('2d');
        if(priceChart) priceChart.destroy();
        
        // ‚úÖ FIX: Read the value from the dropdown
        const tf = document.getElementById('chart-timeframe').value; 
        const data = priceHistory[currentTicker][tf];
        
        if(!data || data.p.length === 0) return;

        priceChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.t,
                datasets: [{
                    label: currentTicker,
                    data: data.p,
                    borderColor: '#38bdf8',
                    backgroundColor: 'rgba(56, 189, 248, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    // Show dots for Daily/Monthly views, hide for Live
                    pointRadius: tf === '60s' ? 0 : 3, 
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { 
                        // Show X-axis labels for history views
                        display: true, 
                        grid: { display: false },
                        ticks: { 
                            maxTicksLimit: 6,
                            color: '#94a3b8',
                            font: { size: 10 }
                        }
                    },
                    y: { 
                        position: 'right',
                        grid: { color: 'rgba(255,255,255,0.05)' },
                        ticks: { color: '#94a3b8', callback: v => '$'+v.toFixed(1) }
                    }
                },
                animation: false
            }
        });
    }

    function updateChart() {
        if(!priceChart) return;
        const data = priceHistory[currentTicker]['60s'];
        priceChart.data.labels = data.t;
        priceChart.data.datasets[0].data = data.p;
        priceChart.update('none');
    }

    // --- Actions ---
   function sendTrade(ticker, type) {
        if(!ws) return;

        // ‚úÖ NEW: Block trade if not subscribed
        if (!subscribedTickers.has(ticker)) {
            alert(`You must SUBSCRIBE to ${ticker} before trading.`);
            return;
        }

        const qty = parseInt(document.getElementById(`qty-${ticker}`).value);
        
        if (isNaN(qty) || qty <= 0) {
            alert('Please enter a valid quantity.');
            return;
        }
        
        ws.send(JSON.stringify({ type, ticker, quantity: qty }));
        
        // Optional: Reset input back to 1
        document.getElementById(`qty-${ticker}`).value = '1';
    }

    function toggleSubscription(ticker) {
        const action = subscribedTickers.has(ticker) ? 'REMOVE' : 'ADD';
        ws.send(JSON.stringify({ type: 'SUBSCRIBE', action, ticker }));
        if(action === 'ADD') subscribedTickers.add(ticker);
        else subscribedTickers.delete(ticker);
        updateButtonState(ticker);
    }

    function updateButtonState(ticker) {
        const btn = document.getElementById(`btn-sub-${ticker}`);
        if(subscribedTickers.has(ticker)) {
            btn.textContent = 'Unsubscribe';
            btn.classList.add('active');
        } else {
            btn.textContent = 'Subscribe';
            btn.classList.remove('active');
        }
    }

    function sendAlert() {
        const ticker = document.getElementById('alert-ticker').value;
        const price = parseFloat(document.getElementById('alert-threshold').value);
        if(ticker && price) ws.send(JSON.stringify({ type: 'SET_ALERT', ticker, threshold: price }));
    }

    function initAlertSelect() {
        const sel = document.getElementById('alert-ticker');
        sel.innerHTML = '';
        SUPPORTED_STOCKS.forEach(t => {
            const opt = document.createElement('option');
            opt.value = t; opt.textContent = t;
            sel.appendChild(opt);
        });
    }

    function renderActiveAlerts() {
        const ul = document.getElementById('active-alerts-list');
        ul.innerHTML = '';
        Object.keys(activeAlerts).forEach(t => {
            const li = document.createElement('li');
            li.innerHTML = `${t} < ${activeAlerts[t]}`;
            ul.appendChild(li);
        });
    }

    // --- Notifications & Logs ---
    function showTradeMessage(msg) {
        const el = document.getElementById('trade-message');
        el.textContent = msg;
        el.className = msg.includes('failed') ? 'down' : 'up';
        setTimeout(() => el.textContent = '', 4000);
    }

    function handleTradeMessage(msg) {
        if (!msg.includes("Successfully")) return; 
        const regex = /Successfully (bought|sold) (\d+) shares of ([A-Z]+) @ \$(\d+\.?\d*)\./; 
        const match = msg.match(regex);
        if (match) {
            fullTransactionLog.unshift({
                time: new Date().toLocaleTimeString(),
                action: match[1].toUpperCase(),
                quantity: match[2],
                ticker: match[3],
                price: parseFloat(match[4])
            });
            if(currentTicker === match[3]) renderTransactionLog();
        }
    }

    function showNotification(msg) {
        const el = document.getElementById('alert-notification');
        el.textContent = msg;
        el.style.display = 'block';
        setTimeout(() => el.style.display = 'none', 5000);
    }

</script>
</body>
</html>